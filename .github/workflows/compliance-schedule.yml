name: Weekly Asset Review
on:
  schedule:
    - cron: '0 0 * * 1' 
  workflow_dispatch: 

# Added permissions block to ensure the GITHUB_TOKEN can write the Dashboard and the PR
permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  inventory:
    runs-on: [self-hosted, Linux]
    timeout-minutes: 10 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Git User
        run: |
          git config --global user.name "Compliance-Bot"
          git config --global user.email "compliance-bot@example.com"

      - name: Run Inventory Script (Attempt 1)
        id: run_script
        continue-on-error: true 
        run: python3 inventory_collector.py

      - name: Retry Script (Attempt 2)
        if: steps.run_script.outcome == 'failure'
        run: |
          echo "First attempt failed. Waiting 60 seconds before retrying..."
          sleep 60
          python3 inventory_collector.py

      - name: Deploy Dashboard to GitHub Pages (Visual Evidence)
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ 
          publish_branch: gh-pages # This creates a website at your-username.github.io/your-repo/

      - name: Create Pull Request (On Success)
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Weekly Inventory Update for NIST 800-53"
          title: "NIST 800-53: System Inventory Review"
          body: "Automated update of system components. Dashboard has been updated at GitHub Pages."
          branch: compliance-update
          delete-branch: true

      - name: Send Slack Notification (On Failure)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: '#ff0000'
          SLACK_TITLE: 'CRITICAL: NIST 800-53 Control Failure'
          SLACK_MESSAGE: 'The Weekly Asset Inventory failed after 2 attempts. Please check the Local Runner and Minikube status.'
