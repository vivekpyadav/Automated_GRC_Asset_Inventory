name: Weekly Asset Review
on:
  schedule:
    - cron: '0 0 * * 1' 
  workflow_dispatch: 

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  inventory:
    runs-on: [self-hosted, Linux]
    timeout-minutes: 10 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          path: . # Explicitly set path to avoid nesting errors

      - name: Fix Git Safe Directory
        # This prevents the 'ENOENT' error by telling Git the local folder is safe
        run: git config --global --add safe.directory ${{ github.workspace }}

      - name: Setup Git User
        run: |
          git config --global user.name "Compliance-Bot"
          git config --global user.email "compliance-bot@example.com"

      - name: Run Inventory Script (Attempt 1)
        id: run_script
        continue-on-error: true 
        run: python3 inventory_collector.py

      - name: Retry Script (Attempt 2)
        if: steps.run_script.outcome == 'failure'
        run: |
          echo "First attempt failed. Waiting 60 seconds before retrying..."
          sleep 60
          python3 inventory_collector.py

      - name: Write Job Summary
        # This creates the table in the GitHub Actions UI
        if: always()
        run: |
          if [ -f github_summary.md ]; then
            cat github_summary.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deploy Dashboard to GitHub Pages (Visual Evidence)
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ 
          publish_branch: gh-pages

      - name: Manual Git Push (Alternative to PR)
        if: success()
        run: |
          # 1. Configure the remote URL with the GITHUB_TOKEN for authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # 2. Add the updated inventory and dashboard
          git add asset_inventory.json index.html github_summary.md
          
          # 3. Check if there are actually changes to commit
          if git diff --staged --quiet; then
            echo "No changes in inventory. Skipping push."
          else
            # 4. Commit and push directly to master
            git commit -m "Compliance Update: Run #${{ github.run_number }}"
            git push origin HEAD:master
          fi

      - name: Send Slack Notification (On Failure)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: '#ff0000'
          SLACK_TITLE: 'CRITICAL: NIST 800-53 Control Failure'
          SLACK_MESSAGE: 'The Weekly Asset Inventory failed after 2 attempts. Please check the Local Runner and Minikube status.'
