name: Weekly Asset Review
on:
  schedule:
    - cron: '0 0 * * 1' 
  workflow_dispatch:
    # Adding the selection menu for Audit vs Remediation
    inputs:
      action_type:
        description: 'Choose Governance Action'
        required: true
        type: choice
        default: 'audit'
        options:
          - audit
          - remediate

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  inventory:
    runs-on: [self-hosted, Linux]
    timeout-minutes: 10 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          path: .

      - name: Fix Git Safe Directory
        run: git config --global --add safe.directory ${{ github.workspace }}

      - name: Setup Git User
        run: |
          git config --global user.name "Compliance-Bot"
          git config --global user.email "compliance-bot@example.com"

      - name: Run Inventory Script
        id: run_script
        # Logic to pass the --fix flag ONLY if 'remediate' is selected
        run: |
          if [ "${{ github.event.inputs.action_type }}" == "remediate" ]; then
            echo "ðŸš€ Running in REMEDIATION mode..."
            python3 inventory_collector.py --fix
          else
            echo "ðŸ›¡ï¸ Running in AUDIT mode..."
            python3 inventory_collector.py
          fi

      - name: Write Job Summary
        if: always()
        run: |
          if [ -f github_summary.md ]; then
            cat github_summary.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Manual Git Push (Update Master)
        if: success()
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add asset_inventory.json index.html github_summary.md || echo "Files missing"
          
          if git diff --staged --quiet; then
            echo "No changes in inventory. Skipping push."
          else
            git commit -m "Compliance Update (${{ github.event.inputs.action_type }}): Run #${{ github.run_number }}"
            git push origin HEAD:master
          fi

      - name: Deploy Dashboard to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ 
          publish_branch: gh-pages

      - name: Send Slack Notification (On Failure)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: '#ff0000'
          SLACK_TITLE: 'CRITICAL: NIST 800-53 Control Failure'
          SLACK_MESSAGE: 'The Weekly Asset Inventory failed. Action Type: ${{ github.event.inputs.action_type }}'
