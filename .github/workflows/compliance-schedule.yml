name: Weekly Asset Review
on:
  schedule:
    - cron: '0 0 * * 1' 
  workflow_dispatch: 

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  inventory:
    runs-on: [self-hosted, Linux]
    timeout-minutes: 10 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          path: . # Explicitly set path to avoid nesting errors

      - name: Fix Git Safe Directory
        # This prevents the 'ENOENT' error by telling Git the local folder is safe
        run: git config --global --add safe.directory ${{ github.workspace }}

      - name: Setup Git User
        run: |
          git config --global user.name "Compliance-Bot"
          git config --global user.email "compliance-bot@example.com"

      - name: Run Inventory Script (Attempt 1)
        id: run_script
        continue-on-error: true 
        run: python3 inventory_collector.py

      - name: Retry Script (Attempt 2)
        if: steps.run_script.outcome == 'failure'
        run: |
          echo "First attempt failed. Waiting 60 seconds before retrying..."
          sleep 60
          python3 inventory_collector.py

      - name: Write Job Summary
        # This creates the table in the GitHub Actions UI
        if: always()
        run: |
          if [ -f github_summary.md ]; then
            cat github_summary.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deploy Dashboard to GitHub Pages (Visual Evidence)
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ 
          publish_branch: gh-pages

      - name: Create Pull Request (On Success)
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: . # Match the checkout path
          commit-message: "Weekly Inventory Update for NIST 800-53"
          title: "NIST 800-53: System Inventory Review"
          body: "Automated update of system components. Check the Action Summary for the live table."
          branch: compliance-update
          delete-branch: true

      - name: Send Slack Notification (On Failure)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: '#ff0000'
          SLACK_TITLE: 'CRITICAL: NIST 800-53 Control Failure'
          SLACK_MESSAGE: 'The Weekly Asset Inventory failed after 2 attempts. Please check the Local Runner and Minikube status.'
